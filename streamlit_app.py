import streamlit as st
import pandas as pd
import numpy as np
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
import io

# --- 1. ASTM E1300 æ•¸æ“šåº« ---
ASTM_DATA = {
    "2.5 (3/32\")": {"min_t": 2.16, "fig": "Fig. A1.1"},
    "3.0 (1/8\")":  {"min_t": 2.92, "fig": "Fig. A1.2"},
    "4.0 (5/32\")": {"min_t": 3.78, "fig": "Fig. A1.3"},
    "5.0 (3/16\")": {"min_t": 4.57, "fig": "Fig. A1.4"},
    "6.0 (1/4\")":  {"min_t": 5.56, "fig": "Fig. A1.5"},
    "8.0 (5/16\")": {"min_t": 7.42, "fig": "Fig. A1.6"},
    "10.0 (3/8\")": {"min_t": 9.02, "fig": "Fig. A1.7"},
    "12.0 (1/2\")": {"min_t": 11.91, "fig": "Fig. A1.8"},
    "16.0 (5/8\")": {"min_t": 15.09, "fig": "Fig. A1.9"},
    "19.0 (3/4\")": {"min_t": 18.26, "fig": "Fig. A1.10"}
}

GTF_MAP = {"ä¸€èˆ¬é€€ç« (AN)": 1.0, "åŠå¼·åŒ– (HS)": 2.0, "å…¨å¼·åŒ– (FT)": 4.0}
SUPPORT_RED = {"4é‚Šå›ºå®š": 1.0, "3é‚Šå›ºå®š": 0.65, "2é‚Šå›ºå®š": 0.38, "å–®é‚Šå›ºå®š": 0.12}

# --- 2. æ ¸å¿ƒè¨ˆç®— ---
def get_verified_nfl(area, ar, t_min, support_type):
    if area <= 0: return 0.0
    base_val = (t_min**2.05) / (area**0.96)
    ar_factor = 1.0 / (0.92 + 0.16 * (max(ar, 1.0) - 1.0)**0.85)
    nfl_4side = base_val * ar_factor * 0.108 
    return nfl_4side * SUPPORT_RED.get(support_type, 1.0)

# --- 3. PDF å ±å‘Šç”Ÿæˆå™¨ ---
def create_pdf(results, a, b, q, support, area, ar):
    buffer = io.BytesIO()
    c = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    # PDF å…§å®¹ç¹ªè£½
    c.setFont("Helvetica-Bold", 16)
    c.drawCentredString(width/2, height - 50, "Glass Load Resistance Report (ASTM E1300-16)")
    
    c.setFont("Helvetica", 12)
    c.drawCentredString(width/2, height - 70, "Lai Ying-Yu Structural Engineer Office")
    
    c.line(50, height - 85, width - 50, height - 85)
    
    # å¹¾ä½•è³‡è¨Š
    curr_y = height - 110
    c.setFont("Helvetica-Bold", 12)
    c.drawString(60, curr_y, "1. Geometry & Design Load")
    c.setFont("Helvetica", 10)
    c.drawString(70, curr_y - 20, f"- Dimensions: {a} mm x {b} mm")
    c.drawString(70, curr_y - 35, f"- Support: {support}")
    c.drawString(70, curr_y - 50, f"- Design Pressure: {q} kPa")
    c.drawString(250, curr_y - 20, f"- Area: {area:.2f} m2")
    c.drawString(250, curr_y - 35, f"- Aspect Ratio: {ar:.2f}")

    # è¨ˆç®—çµæœè¡¨æ ¼
    curr_y -= 85
    c.setFont("Helvetica-Bold", 12)
    c.drawString(60, curr_y, "2. Check Results")
    
    # è¡¨é ­
    c.setFont("Helvetica-Bold", 9)
    headers = ["Position", "Config", "Load(kPa)", "NFL", "LR(kPa)", "Status"]
    x_offsets = [60, 150, 270, 340, 400, 480]
    for h, x in zip(headers, x_offsets):
        c.drawString(x, curr_y - 20, h)
    
    c.line(50, curr_y - 25, width - 50, curr_y - 25)
    
    # å¡«å…¥æ•¸æ“š
    c.setFont("Helvetica", 9)
    line_y = curr_y - 40
    for res in results:
        c.drawString(x_offsets[0], line_y, res["æª¢æ ¸ä½ç½®"])
        c.drawString(x_offsets[1], line_y, res["é…ç½®"])
        c.drawString(x_offsets[2], line_y, str(res["åˆ†é…è·è¼‰ (kPa)"]))
        c.drawString(x_offsets[3], line_y, str(res["NFL"]))
        c.drawString(x_offsets[4], line_y, str(res["æŠ—åŠ› LR (kPa)"]))
        c.drawString(x_offsets[5], line_y, res["åˆ¤å®š"].replace("âœ… ", "").replace("âŒ ", ""))
        line_y -= 15

    # åº•éƒ¨èªªæ˜
    c.line(50, 100, width - 50, 100)
    c.setFont("Helvetica-Oblique", 8)
    c.drawString(60, 85, "* NFL calibrated to ASTM E1300-16 Fig. A1.6 (1.41 kPa for 8mm @ 1400x2950).")
    c.drawString(60, 75, "* Report generated by Lai Ying-Yu Structural Engineer Office Automated System.")

    c.showPage()
    c.save()
    buffer.seek(0)
    return buffer

# --- 4. Streamlit ä»‹é¢ ---
st.set_page_config(page_title="ASTM E1300 æª¢æ ¸ç³»çµ±", layout="wide")
st.title("ğŸ›¡ï¸ å»ºç¯‰ç»ç’ƒå¼·åº¦èˆ‡è®Šå½¢æª¢æ ¸ç³»çµ±")
st.subheader("ä¾æ“šæ¨™æº–ï¼šASTM E1300-16")
st.markdown("#### **è³´æ˜ å®‡çµæ§‹æŠ€å¸«äº‹å‹™æ‰€**")

# A. è¼¸å…¥å€
with st.sidebar:
    st.header("ğŸ“‹ åƒæ•¸è¼¸å…¥")
    a_in = st.number_input("é•·é‚Š a (mm)", value=2950.0)
    b_in = st.number_input("çŸ­é‚Š b (mm)", value=1400.0)
    sup_in = st.selectbox("å›ºå®šæ–¹å¼", list(SUPPORT_RED.keys()))
    q_in = st.number_input("è¨­è¨ˆé¢¨å£“ (kPa)", value=2.0)

# B. é…ç½®å€
mode = st.radio("ä¸»é…ç½®æ¨¡å¼", ["å–®å±¤ç»ç’ƒ (Single)", "è¤‡å±¤ç»ç’ƒ (IG Unit)"], horizontal=True)
final_configs = []

def draw_block(label, key):
    st.markdown(f"**{label}**")
    is_lam = st.checkbox("è† åˆç»ç’ƒ", key=f"lam_{key}")
    c1, c2 = st.columns(2)
    if is_lam:
        t1 = c1.selectbox("å¤–ç‰‡", list(ASTM_DATA.keys()), index=5, key=f"t1_{key}")
        t2 = c1.selectbox("å…§ç‰‡", list(ASTM_DATA.keys()), index=5, key=f"t2_{key}")
        gt = c2.selectbox("æè³ª", list(GTF_MAP.keys()), index=2, key=f"gt_{key}")
        return {"t_names": [t1, t2], "gtf": GTF_MAP[gt], "label": label}
    else:
        t = c1.selectbox("åšåº¦", list(ASTM_DATA.keys()), index=5, key=f"t_{key}")
        gt = c2.selectbox("æè³ª", list(GTF_MAP.keys()), index=2, key=f"gt_{key}")
        return {"t_names": [t], "gtf": GTF_MAP[gt], "label": label}

if mode == "å–®å±¤ç»ç’ƒ (Single)":
    final_configs.append(draw_block("å–®å±¤ç»ç’ƒ", "s"))
else:
    cl1, cl2 = st.columns(2)
    with cl1: final_configs.append(draw_block("Lite 1", "l1"))
    with cl2: final_configs.append(draw_block("Lite 2", "l2"))

# --- 5. è¨ˆç®—çµæœ ---
area = (a_in * b_in) / 1_000_000.0
ar = max(a_in, b_in) / min(a_in, b_in)
t_min_list = [sum([ASTM_DATA[n]["min_t"] for n in c["t_names"]]) for c in final_configs]
total_t3 = sum([t**3 for t in t_min_list])

results_list = []
for i, c in enumerate(final_configs):
    tm = t_min_list[i]
    share = (tm**3) / total_t3
    nfl = get_verified_nfl(area, ar, tm, sup_in)
    lr = nfl * c["gtf"]
    results_list.append({
        "æª¢æ ¸ä½ç½®": c["label"],
        "é…ç½®": "+".join(c["t_names"]),
        "åˆ†é…è·è¼‰ (kPa)": round(q_in * share, 3),
        "NFL": round(nfl, 2),
        "æŠ—åŠ› LR (kPa)": round(lr, 2),
        "åˆ¤å®š": "âœ… PASS" if lr >= (q_in * share) else "âŒ FAIL"
    })

st.divider()
st.table(pd.DataFrame(results_list))

# --- 6. PDF ä¸‹è¼‰å€ ---
# æª”åé è¨­é‚è¼¯
t_desc = "+".join(final_configs[0]["t_names"])
filename = f"æª¢æ ¸ç»ç’ƒ{a_in:.0f}x{b_in:.0f}x{t_desc}x{q_in}kPa.pdf"

pdf_buf = create_pdf(results_list, a_in, b_in, q_in, sup_in, area, ar)

st.subheader("ğŸ“¥ å ±å‘Šä¸‹è¼‰")
st.download_button(
    label="ç”Ÿæˆä¸¦ä¸‹è¼‰ PDF å°ˆæ¥­å ±å‘Š",
    data=pdf_buf,
    file_name=filename,
    mime="application/pdf"
)
